#!/usr/bin/env bash

set -euxo pipefail

# operator-sdk run bundle<-upgrade> doesn't support local images and the image
# has to be pushed to a remote registry.
# When the command is run, operator-sdk checks the image twice. At first, it
# validates that the image exists and then it creates a pod in the cluster
# deploying the image, therefore, the image has to be accessed from both, the
# running host and the minikube cluster.
sudo echo "127.0.0.1 host.minikube.internal" | sudo tee -a /etc/hosts

# Install OLM
make operator-sdk
./bin/operator-sdk olm install

# It takes some time for the operatorhubio-catalog catalogsource to get to a
# READY connection state. The catalog can oscillate between READY and
# TRANSIENT_FAILURE, so we wait for it to be stable (consecutive READY states)
# before proceeding. This prevents race conditions where the catalog becomes
# unavailable between our readiness check and the actual bundle installation.
wait_for_operatorhubio_catalog_to_be_ready() {
  echo "Waiting for operatorhubio-catalog to stabilize"
  timeout 5m bash -c '
    stable_count=0
    required_stable=6  # 6 consecutive checks

    while [ "$stable_count" -lt "$required_stable" ]; do
      state=$(kubectl -n olm get catalogsource/operatorhubio-catalog -o jsonpath="{.status.connectionState.lastObservedState}" 2>/dev/null || echo "UNAVAILABLE")
      if [ "$state" = "READY" ]; then
        stable_count=$((stable_count + 1))
        echo "Catalog READY ($stable_count/$required_stable)"
      else
        if [ "$stable_count" -gt 0 ]; then
          echo "Catalog state: $state - resetting stability counter"
        else
          echo "Catalog state: $state - waiting"
        fi
        stable_count=0
      fi
      sleep 5
    done
  '
  echo "Catalog is stabilized"
}

# Install the `clusteradm` command
curl -LO https://raw.githubusercontent.com/open-cluster-management-io/clusteradm/v0.7.2/install.sh
chmod +x install.sh
./install.sh 0.7.2

# Init OCM in the cluster
clusteradm init --wait
kubectl wait --for=condition=Available -n open-cluster-management deployment/cluster-manager
kubectl wait --for=condition=Available --timeout=2m -n open-cluster-management-hub \
    deployment/cluster-manager-placement-controller \
    deployment/cluster-manager-registration-controller \
    deployment/cluster-manager-registration-webhook \
    deployment/cluster-manager-work-webhook

# Wait for catalog to be stable before querying it
wait_for_operatorhubio_catalog_to_be_ready

# Deploy the current bundle
kubectl -n olm patch svc/operatorhubio-catalog --type merge -p '{"spec":{"type": "NodePort"}}'
catalog_url=$(minikube service operatorhubio-catalog -n olm --url | cut -d"/" -f3)
latest_published_bundle=$(grpcurl -d '{"pkgName": "kernel-module-management-hub", "channelName": "alpha"}' -plaintext ${catalog_url} api.Registry/GetBundleForChannel | jq -r '.bundlePath')

./bin/operator-sdk run bundle ${latest_published_bundle} \
    --use-http \
    --timeout 5m0s
kubectl wait --for=condition=Available --timeout=1m deployment/kmm-operator-hub-controller

# Build the new bundle
make bundle-hub bundle-build bundle-push \
    HUB_IMG=host.minikube.internal:5000/kmm/kmm-hub:local \
    SIGNER_IMG=host.minikube.internal:5000/kmm/signimage:local \
    WEBHOOK_IMG=host.minikube.internal:5000/kmm/webhook-server:local \
    BUNDLE_IMG=localhost:5000/kmm/kmm-hub-bundle:local

# Upgrade to the new bundle
./bin/operator-sdk run bundle-upgrade host.minikube.internal:5000/kmm/kmm-hub-bundle:local \
    --use-http \
    --timeout 5m0s
kubectl wait --for=condition=Available --timeout=1m \
    deployment/kmm-operator-hub-controller \
    deployment/kmm-operator-hub-webhook

