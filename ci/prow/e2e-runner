#!/usr/bin/env bash

set -euxo pipefail

# FIXME: remove: This is done in the kubekins-e2e image entrypoint
#/workspace/test-infra/images/kubekins-e2e/install-bazel.sh

# FIXME: remove: This is done in the kubekins-e2e image entrypoint?
go install sigs.k8s.io/kubetest2@latest
go install sigs.k8s.io/kubetest2/kubetest2-gce@latest
go install sigs.k8s.io/kubetest2/kubetest2-tester-exec@latest

rmdir /go/src/k8s.io/kubernetes
git clone https://github.com/kubernetes/kubernetes.git /go/src/k8s.io/kubernetes

#FIXME: use /usr/local/bin/kubetest2 instead

#FIXME: do we need to --build?
# I think --legacy-mode is required to get a vanila k8s instead of a google k8s
#kubetest2 gce -v 2 \
kubetest2 gce -v 2 \
    --repo-root /go/src/k8s.io/kubernetes \
    --legacy-mode \
    --build \
    --up \
    --down \
    --test=exec -- ${TEST}
